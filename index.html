<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ICSTIC — The Interact Club of St. Thomas' Catholic International College</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  html{scroll-behavior:smooth}
  .aurora{background:
    radial-gradient(1200px 600px at 10% 10%, rgba(16,185,129,.35), transparent 60%),
    radial-gradient(1000px 500px at 90% 20%, rgba(59,130,246,.30), transparent 60%),
    radial-gradient(1000px 700px at 30% 90%, rgba(234,179,8,.25), transparent 60%),
    linear-gradient(180deg,#0b1220 0%,#0e1324 40%,#0f172a 100%)}
  .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
  .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.5rem 1rem;font-weight:500;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:all .2s}
  .btn-primary{background:#10b981;color:#fff}.btn-primary:hover{background:#059669}
  .btn-rose{background:#f43f5e;color:#fff}.btn-rose:hover{background:#e11d48}
  .btn-ghost{background:rgba(255,255,255,.1);color:#fff}.btn-ghost:hover{background:rgba(255,255,255,.2)}
  .tag{font-size:.75rem;padding:.125rem .5rem;border-radius:999px;background:rgba(255,255,255,.1);color:#fff}
  dialog::backdrop{background:rgba(0,0,0,.6)}
</style>
</head>
<body class="aurora min-h-screen text-white">
<header class="sticky top-0 z-50 glass">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between py-3">
      <div class="flex items-center gap-3">
        <img id="clubLogo" alt="ICSTIC logo" class="h-10 w-10 rounded-full ring-2 ring-white/20 object-cover"/>
        <div>
          <h1 class="text-xl font-bold">ICSTIC</h1>
          <p class="text-xs text-white/70">The Interact Club of St. Thomas' Catholic International College</p>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#home" class="hover:text-emerald-300">Home</a>
        <a href="#member" class="hover:text-emerald-300">Members</a>
        <a href="#chat" class="hover:text-emerald-300">Chat</a>
        <a href="#calendar" class="hover:text-emerald-300">Calendar</a>
        <a href="#best" class="hover:text-emerald-300">Best Interactor</a>
        <a href="#photos" class="hover:text-emerald-300">Family Photos</a>
        <a href="#about" class="hover:text-emerald-300">About</a>
        <a href="#admin" class="hover:text-emerald-300">Admin</a>
      </nav>
      <button class="md:hidden btn btn-ghost" id="openNav"><i data-lucide="menu" class="w-5 h-5"></i></button>
    </div>
    <div id="mobileNav" class="hidden border-t border-white/10 pb-3 md:hidden">
      <div class="grid grid-cols-2 gap-2 pt-3 text-sm">
        <a href="#home" class="btn btn-ghost">Home</a>
        <a href="#member" class="btn btn-ghost">Members</a>
        <a href="#chat" class="btn btn-ghost">Chat</a>
        <a href="#calendar" class="btn btn-ghost">Calendar</a>
        <a href="#best" class="btn btn-ghost">Best Interactor</a>
        <a href="#photos" class="btn btn-ghost">Family Photos</a>
        <a href="#about" class="btn btn-ghost col-span-2">About</a>
        <a href="#admin" class="btn btn-ghost col-span-2">Admin</a>
      </div>
    </div>
  </div>
</header>

<!-- HOME -->
<section id="home" class="max-w-7xl mx-auto px-4 py-10">
  <div class="grid md:grid-cols-2 gap-8 items-center">
    <div class="space-y-5">
      <h2 class="text-3xl md:text-4xl font-extrabold">Welcome to ICSTIC</h2>
      <p class="text-white/80 leading-relaxed">
        Welcome to the official page of our Interact club. Here you will find everything you need to know about being a member of our Interact Club and the role you play in this Family.
      </p>
      <div class="flex gap-3">
        <a href="#member" class="btn btn-primary">Member Login</a>
        <a href="#admin" class="btn btn-rose">Admin Area</a>
      </div>
    </div>
    <div class="glass rounded-3xl p-6">
      <div class="flex items-center gap-4">
        <img id="heroLogo" class="h-24 w-24 rounded-2xl ring-2 ring-white/10 object-cover" alt="ICSTIC logo"/>
        <div>
          <h3 class="text-2xl font-semibold">ICSTIC</h3>
          <div class="text-sm text-white/70">The Interact Club of St. Thomas' Catholic International College</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MEMBERS -->
<section id="member" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Members Area</h2>
  <div id="memberGate" class="glass rounded-2xl p-6">
    <div class="grid md:grid-cols-2 gap-6 items-end">
      <div>
        <label class="block text-sm mb-1">Your Name</label>
        <input id="memberName" class="w-full rounded-xl bg-white/10 border border-white/20 p-3 outline-none" placeholder="Your name"/>
      </div>
      <div>
        <label class="block text-sm mb-1">Member Password</label>
        <input id="memberPass" type="password" class="w-full rounded-xl bg-white/10 border border-white/20 p-3 outline-none" placeholder="Password"/>
      </div>
    </div>
    <div class="mt-4 flex gap-3">
      <button id="memberEnter" class="btn btn-primary">Enter</button>
    </div>
  </div>

  <div id="memberPanel" class="hidden mt-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">This Week's Tasks — <span id="memberWeek"></span></h3>
      <div class="text-sm text-white/70">Logged in as <span id="memberWho" class="font-semibold"></span></div>
    </div>
    <div id="memberTasks"></div>
    <div class="mt-6 flex items-center gap-3">
      <button id="memberSubmit" class="btn btn-primary">Submit</button>
      <span id="memberMsg" class="text-sm"></span>
    </div>
  </div>
</section>

<!-- CHAT (private member <-> admin) -->
<section id="chat" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Chat</h2>

  <!-- Member chat view -->
  <div id="chatMemberGate" class="glass rounded-2xl p-6">
    <p class="text-white/80">Log in as a member in the Members Area to start a private chat with the admins.</p>
  </div>

  <div id="chatMember" class="hidden glass rounded-2xl p-6">
    <div class="text-sm text-white/70 mb-3">Private chat with Admins — visible only to <span id="chatMemberName" class="font-semibold"></span> and Admins.</div>
    <div id="memberChatBox" class="space-y-3 max-h-72 overflow-auto pr-1 bg-white/5 rounded-xl p-3"></div>
    <div class="mt-3 flex gap-2">
      <input id="memberChatInput" class="flex-1 rounded-xl bg-white/10 border border-white/20 p-3 outline-none" placeholder="Ask a question..."/>
      <button id="memberChatSend" class="btn btn-primary">Send</button>
    </div>
  </div>

  <!-- Admin chat manager -->
  <div id="chatAdmin" class="hidden glass rounded-2xl p-6 admin-only">
    <h3 class="text-xl font-semibold mb-3">Member Questions (Private Threads)</h3>
    <div id="chatThreads" class="grid md:grid-cols-2 gap-4"></div>
  </div>
</section>

<!-- ADMIN -->
<section id="admin" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Admin Area</h2>
  <div id="adminGate" class="glass rounded-2xl p-6">
    <div class="grid md:grid-cols-2 gap-6 items-end">
      <div>
        <label class="block text-sm mb-1">Admin Name</label>
        <input id="adminName" class="w-full rounded-xl bg-white/10 border border-white/20 p-3 outline-none" placeholder="Admin name"/>
      </div>
      <div>
        <label class="block text-sm mb-1">Admin Password</label>
        <input id="adminPass" type="password" class="w-full rounded-xl bg-white/10 border border-white/20 p-3 outline-none" placeholder="Password"/>
      </div>
    </div>
    <div class="mt-4 flex gap-3">
      <button id="adminEnter" class="btn btn-rose">Enter Admin</button>
    </div>
  </div>

  <div id="adminPanel" class="hidden mt-6 space-y-8">
    <div class="glass rounded-2xl p-6 admin-only">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Tasks by Member — Week <span id="adminWeek"></span></h3>
        <button id="rollWeek" class="btn btn-ghost" title="Run weekly check (removes members failing 3 weeks)">Weekly Check</button>
      </div>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="newMember" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Member name"/>
        <input id="newTask" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Task description"/>
        <button id="addTask" class="btn btn-primary">Add Task</button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-6" id="adminMembers"></div>
    </div>

    <div class="glass rounded-2xl p-6 admin-only">
      <h3 class="text-xl font-semibold mb-3">Site Settings</h3>
      <div class="flex flex-wrap items-center gap-4">
        <label class="text-sm">Upload Logo <input id="logoUploader" type="file" accept="image/*" class="ml-2"/></label>
        <button id="exportData" class="btn btn-ghost">Export Data</button>
        <input id="importFile" type="file" accept="application/json" class="hidden"/>
        <button id="importDataBtn" class="btn btn-ghost">Import Data</button>
        <button id="resetAll" class="btn btn-rose">Reset Everything</button>
      </div>
    </div>
  </div>
</section>

<!-- CALENDAR -->
<section id="calendar" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Projects & Calendar</h2>
  <div class="glass rounded-2xl p-6">
    <div class="grid md:grid-cols-[2fr,3fr] gap-6">
      <div class="admin-only">
        <label class="block text-sm mb-1">Add Event</label>
        <div class="grid gap-2">
          <input id="calTitle" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Event title"/>
          <input id="calDate" type="date" class="rounded-xl bg-white/10 border border-white/20 p-3"/>
          <input id="calDesc" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Description (optional)"/>
          <button id="addEvent" class="btn btn-primary w-max">Add</button>
        </div>
      </div>
      <div>
        <div id="calendarList" class="space-y-2 max-h-80 overflow-auto"></div>
      </div>
    </div>
  </div>
</section>

<!-- BEST INTERACTOR -->
<section id="best" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Best Interactor</h2>
  <div class="glass rounded-2xl p-6">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="admin-only">
        <h3 class="font-semibold mb-2">Admin Controls</h3>
        <div class="grid gap-2">
          <input id="nomName" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Interactor name"/>
          <input id="nomClass" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Class/Role (optional)"/>
          <label class="text-sm">Photo <input id="nomPhoto" type="file" accept="image/*" class="ml-2"/></label>
          <button id="addNominee" class="btn btn-primary w-max">Add Nominee</button>
          <button id="clearNominees" class="btn btn-ghost w-max">Clear Nominees</button>
          <div class="border-t border-white/10 pt-3">
            <label class="block text-sm mb-1">Pick Winner (Week 4)</label>
            <select id="winnerSelect" class="rounded-xl bg-white/10 border border-white/20 p-3"></select>
            <button id="setWinner" class="btn btn-rose mt-2">Set Winner</button>
          </div>
        </div>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Public View</h3>
        <div id="bestPublic"></div>
      </div>
    </div>
  </div>
</section>

<!-- PHOTOS with ALBUMS -->
<section id="photos" class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-4">Family Photos</h2>
  <div class="glass rounded-2xl p-6">
    <!-- Admin album controls -->
    <div class="admin-only mb-4 grid md:grid-cols-[2fr,3fr] gap-4">
      <div class="space-y-2">
        <label class="block text-sm">Create Album</label>
        <div class="flex gap-2">
          <input id="albumName" class="flex-1 rounded-xl bg-white/10 border border-white/20 p-3" placeholder="Album name (e.g., Installation 2025)"/>
          <button id="addAlbum" class="btn btn-primary">Add</button>
        </div>
        <div class="text-xs text-white/60">Admins can create, rename, delete albums and upload photos into the selected album.</div>
      </div>
      <div class="space-y-2">
        <label class="block text-sm">Manage Selected Album</label>
        <div class="flex flex-wrap gap-2">
          <input id="renameAlbumInput" class="rounded-xl bg-white/10 border border-white/20 p-3" placeholder="New album name"/>
          <button id="renameAlbum" class="btn btn-ghost">Rename</button>
          <button id="deleteAlbum" class="btn btn-rose">Delete Album</button>
          <label class="text-sm">Upload Photos
            <input id="galUpload" type="file" accept="image/*" multiple class="ml-2"/>
          </label>
          <button id="clearAlbum" class="btn btn-ghost">Clear Photos</button>
        </div>
      </div>
    </div>

    <!-- Album picker (visible to all) -->
    <div class="mb-3 flex items-center gap-3">
      <label class="text-sm">Album</label>
      <select id="albumSelect" class="rounded-xl bg-white/10 border border-white/20 p-2"></select>
    </div>

    <!-- Gallery grid -->
    <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
  </div>
</section>

<!-- ABOUT -->
<section id="about" class="max-w-7xl mx-auto px-4 py-10">
  <div class="glass rounded-2xl p-6 space-y-3">
    <p class="font-bold">Psalm 20:7 - Some Trust in chariots and some in horses , but we trust in the Lord our God</p>
    <p class="text-white/80">
      The return of a family who seperated after two years of failing to work together , but this time bigger and better to prove the truth in the 3 most cliche words existent to man " Never Give Up " .
    </p>
  </div>
</section>

<!-- TOAST -->
<dialog id="toast" class="rounded-xl p-0 bg-white/95 text-slate-900 min-w-[280px]"><div class="p-4 text-center space-y-2">
  <div id="toastMsg" class="font-semibold"></div><button onclick="document.getElementById('toast').close()" class="btn">Close</button></div></dialog>

<script>
/* ---------- helpers & storage ---------- */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const store={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
function isoWeek(d=new Date()){const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);const y=new Date(Date.UTC(t.getUTCFullYear(),0,1));const w=Math.ceil((((t-y)/86400000)+1)/7);return {year:t.getUTCFullYear(),week:w}}
function weekKey(o){return `${o.year}-W${String(o.week).padStart(2,'0')}`}
function weekOfMonth(dt=new Date()){const d=new Date(dt);const f=new Date(d.getFullYear(),d.getMonth(),1).getDay();return Math.ceil((d.getDate()+f)/7)}
function showToast(msg){$('#toastMsg').textContent=msg;$('#toast').showModal()}

const MEMBER_PASSWORD = '02';     // not shown in UI
const ADMIN_PASSWORD  = 'Admin123';// not shown in UI

/* ---------- database ---------- */
const db = store.get('icstic', {
  logoDataUrl:null,
  members:{},          // {name:{removed,fails,lastChecked}}
  tasks:{},            // {weekKey:{member:[{id,text,done}]}}
  chat:[],             // [{id, member, role:'member'|'admin', text, ts}]
  calendar:[],         // [{id,title,date,desc}]
  nominees:{},         // {YYYY-MM:{list:[{id,name,klass,photo}], winnerId}}
  albums:{},           // {albumName:[dataUrl,...]}
  currentAlbum:null
});
const save=()=>store.set('icstic',db);

/* ---------- branding ---------- */
function defaultLogo(){return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#0ea5e9"/><stop offset="1" stop-color="#22c55e"/></linearGradient></defs><rect width="200" height="200" rx="28" fill="url(#g)"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="72" fill="white">I</text></svg>`)}
function setLogo(u){$('#clubLogo').src=u||defaultLogo();$('#heroLogo').src=u||defaultLogo()}
setLogo(db.logoDataUrl);

/* ---------- nav ---------- */
$('#openNav').onclick=()=>$('#mobileNav').classList.toggle('hidden');

/* ---------- admin visibility ---------- */
function hideAdminOnly(){$$('.admin-only').forEach(e=>e.classList.add('hidden'))}
function showAdminOnly(){$$('.admin-only').forEach(e=>e.classList.remove('hidden'))}
hideAdminOnly();

/* ---------- member area ---------- */
let currentMember=null;
function ensureMember(n){if(!db.members[n]) db.members[n]={removed:false,fails:0,lastChecked:null}}
function renderMemberTasks(n){const wk=weekKey(isoWeek());$('#memberWeek').textContent=wk;const list=(db.tasks[wk]?.[n]??[]);const root=$('#memberTasks');root.innerHTML='';if(list.length===0){root.innerHTML='<div class="glass rounded-2xl p-4">No tasks yet.</div>';return}list.forEach(t=>{const c=document.createElement('div');c.className='glass rounded-2xl p-4 flex items-start gap-3';c.innerHTML=`<input type="checkbox" ${t.done?'checked':''} class="mt-1 h-5 w-5 shrink-0"/> <div><div class="font-medium">${t.text}</div><div class="text-xs text-white/60">Task ID: ${t.id}</div></div>`;c.querySelector('input').onchange=e=>{t.done=e.target.checked;save()};root.appendChild(c)})}
function evaluateMember(n){const k=weekKey(isoWeek());const tasks=db.tasks[k]?.[n]??[];const all=tasks.length>0&&tasks.every(t=>t.done);const m=$('#memberMsg');if(all){m.textContent='GREAT JOB , MY FRIEND';showToast('GREAT JOB , MY FRIEND')}else{m.textContent='HOPE YOU DO BETTER NEXT TIME , FRIEND';showToast('HOPE YOU DO BETTER NEXT TIME , FRIEND')}const mm=db.members[n];if(!all){mm.fails=(mm.fails||0)+1}else{mm.fails=0}if(mm.fails>=3){mm.removed=true;showToast(`${n} removed after 3 failed weeks`)}mm.lastChecked=k;save()}
$('#memberEnter').onclick=()=>{const n=$('#memberName').value.trim();const p=$('#memberPass').value.trim();if(!n)return showToast('Enter your name');if(p!==MEMBER_PASSWORD)return showToast('Wrong member password');ensureMember(n);save();currentMember=n;$('#memberWho').textContent=n;$('#memberGate').classList.add('hidden');$('#memberPanel').classList.remove('hidden');renderMemberTasks(n);renderMemberChat();$('#chatMemberGate').classList.add('hidden');$('#chatMember').classList.remove('hidden');$('#chatMemberName').textContent=n}
$('#memberSubmit').onclick=()=>evaluateMember(currentMember);

/* ---------- private chat ---------- */
// messages keyed by 'member' field; member sees only their own; admin sees all grouped
function renderMemberChat(){const box=$('#memberChatBox');if(!box)return;box.innerHTML='';db.chat.filter(m=>m.member===currentMember).forEach(m=>{const mine=m.role==='member';const row=document.createElement('div');row.className='flex items-start gap-2';row.innerHTML=`<div class="text-xs mt-1 ${mine?'text-white/60':'text-emerald-300'}">${mine?'You':'Admin'}</div><div class="bg-white/10 rounded-xl px-3 py-2 flex-1">${m.text}</div>`;box.appendChild(row)});box.scrollTop=box.scrollHeight}
$('#memberChatSend').onclick=()=>{if(!currentMember)return showToast('Login as member first');const t=$('#memberChatInput').value.trim();if(!t)return;db.chat.push({id:crypto.randomUUID(),member:currentMember,role:'member',text:t,ts:Date.now()});$('#memberChatInput').value='';save();renderMemberChat();renderAdminThreads()}

function renderAdminThreads(){const root=$('#chatThreads');if(!root)return;root.innerHTML='';const byMember={};db.chat.forEach(m=>{(byMember[m.member] ||= []).push(m)});Object.keys(byMember).sort().forEach(name=>{const msgs=byMember[name];const card=document.createElement('div');card.className='glass rounded-2xl p-3';card.innerHTML=`<div class="flex items-center justify-between mb-2"><div class="font-semibold">${name}</div><div class="text-xs text-white/60">${msgs.length} msg</div></div><div class="space-y-2 max-h-52 overflow-auto pr-1" data-box></div><div class="mt-2 flex gap-2"><input class="flex-1 rounded-xl bg-white/10 border border-white/20 p-2" placeholder="Reply to ${name}..."/><button class="btn btn-primary">Reply</button></div>`;const box=card.querySelector('[data-box]');msgs.forEach(m=>{const r=document.createElement('div');r.className='flex gap-2 items-start';r.innerHTML=`<div class="text-xs mt-1 ${m.role==='admin'?'text-emerald-300':'text-white/60'}">${m.role==='admin'?'Admin':'${name}'}</div><div class="bg-white/10 rounded-xl px-3 py-2 flex-1">${m.text}</div>`;box.appendChild(r)});card.querySelector('button').onclick=()=>{const t=card.querySelector('input').value.trim();if(!t)return;db.chat.push({id:crypto.randomUUID(),member:name,role:'admin',text:t,ts:Date.now()});save();renderAdminThreads();if(currentMember===name)renderMemberChat()};root.appendChild(card)})}

/* ---------- admin login ---------- */
let currentAdmin=null;
function renderAdmin(){ $('#adminWeek').textContent=weekKey(isoWeek()); const panel=$('#adminMembers'); panel.innerHTML=''; const names=Object.keys(db.members).filter(n=>!db.members[n].removed).sort(); const wk=weekKey(isoWeek()); names.forEach(n=>{const tasks=(db.tasks[wk]?.[n]??[]);const card=document.createElement('div');card.className='glass rounded-2xl p-4';card.innerHTML=`<div class="flex items-center justify-between mb-2"><div class="font-semibold">${n}</div><div class="text-xs text-white/60">fails: ${db.members[n].fails||0}</div></div><div class="space-y-2" data-list></div><div class="mt-2 flex gap-2"><button class="btn btn-ghost" data-add>Add Task</button><button class="btn btn-ghost" data-clear>Clear</button><button class="btn btn-rose" data-remove>Remove Member</button></div>`;const list=card.querySelector('[data-list]');tasks.forEach(t=>{const row=document.createElement('div');row.className='flex items-center gap-2';row.innerHTML=`<input type="checkbox" ${t.done?'checked':''}/> <input class="flex-1 rounded-xl bg-white/10 border border-white/20 p-2" value="${t.text}"/> <button class="btn btn-ghost" data-del>✖</button>`;row.querySelector('input[type="checkbox"]').onchange=e=>{t.done=e.target.checked;save()};row.querySelector('input:not([type])').onchange=e=>{t.text=e.target.value;save()};row.querySelector('[data-del]').onclick=()=>{const arr=db.tasks[wk][n];db.tasks[wk][n]=arr.filter(x=>x.id!==t.id);save();renderAdmin()};list.appendChild(row)});card.querySelector('[data-add]').onclick=()=>{addTaskTo(n,$('#newTask').value.trim()||'New Task')};card.querySelector('[data-clear]').onclick=()=>{if(db.tasks[wk]) db.tasks[wk][n]=[];save();renderAdmin()};card.querySelector('[data-remove]').onclick=()=>{db.members[n].removed=true;save();renderAdmin()};panel.appendChild(card)})}
function addTaskTo(n,txt){if(!txt)return showToast('Enter a task');const wk=weekKey(isoWeek());db.tasks[wk] ||= {}; db.tasks[wk][n] ||= []; db.tasks[wk][n].push({id:crypto.randomUUID(),text:txt,done:false});save();renderAdmin();if(currentMember===n)renderMemberTasks(n)}
$('#addTask').onclick=()=>{const n=$('#newMember').value.trim();if(!n)return showToast('Enter member name');ensureMember(n);addTaskTo(n,$('#newTask').value.trim());$('#newTask').value='';save()}
$('#adminEnter').onclick=()=>{const n=$('#adminName').value.trim();const p=$('#adminPass').value.trim();if(!n)return showToast('Enter admin name');if(p!==ADMIN_PASSWORD)return showToast('Wrong admin password');currentAdmin=n;$('#adminGate').classList.add('hidden');$('#adminPanel').classList.remove('hidden');showAdminOnly();renderAdmin();renderAdminThreads();$('#chatAdmin').classList.remove('hidden')}
$('#rollWeek').onclick=()=>{const wk=weekKey(isoWeek());for(const n of Object.keys(db.members)){const m=db.members[n];if(m.removed)continue;const tasks=db.tasks[wk]?.[n]??[];const all=tasks.length>0&&tasks.every(t=>t.done);if(!all){m.fails=(m.fails||0)+1}else{m.fails=0}if(m.fails>=3){m.removed=true}}save();showToast('Weekly check complete.')}

/* ---------- calendar ---------- */
function renderCalendar(){const list=$('#calendarList');list.innerHTML='';db.calendar.sort((a,b)=>a.date.localeCompare(b.date));db.calendar.forEach(e=>{const row=document.createElement('div');row.className='glass rounded-xl p-3 flex items-start justify-between gap-3';row.innerHTML=`<div><div class="font-semibold">${e.title}</div><div class="text-xs text-white/60">${e.date}</div><div class="text-sm">${e.desc||''}</div></div>${currentAdmin?'<button class="btn btn-ghost">✖</button>':''}`;if(currentAdmin)row.querySelector('button').onclick=()=>{db.calendar=db.calendar.filter(x=>x.id!==e.id);save();renderCalendar()};list.appendChild(row)})}
$('#addEvent').onclick=()=>{const t=$('#calTitle').value.trim();const d=$('#calDate').value;const c=$('#calDesc').value.trim();if(!t||!d)return showToast('Add title and date');db.calendar.push({id:crypto.randomUUID(),title:t,date:d,desc:c});save();renderCalendar();$('#calTitle').value='';$('#calDesc').value=''}
renderCalendar();

/* ---------- nominees ---------- */
function monthKey(d=new Date()){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function currentNomBox(){db.nominees[monthKey()] ||= {list:[],winnerId:null};return db.nominees[monthKey()]}
function renderBest(){const meta=currentNomBox();const sel=$('#winnerSelect');if(sel){sel.innerHTML='<option value="">-- choose winner --</option>';meta.list.forEach(n=>{const o=document.createElement('option');o.value=n.id;o.textContent=n.name;sel.appendChild(o)})}const pub=$('#bestPublic');if(!pub)return;pub.innerHTML='';const wom=weekOfMonth();if(meta.winnerId){const w=meta.list.find(x=>x.id===meta.winnerId);const card=document.createElement('div');card.className='glass rounded-2xl p-4 text-center col-span-2';card.innerHTML=`<div class="text-sm text-white/60 mb-1">Best Interactor of the Month</div><img src="${w.photo||defaultLogo()}" class="h-40 w-40 object-cover rounded-2xl mx-auto ring-2 ring-white/10"/><div class="mt-2 text-xl font-bold">${w.name}</div><div class="text-sm text-white/70">${w.klass||''}</div>`;pub.appendChild(card)}else if(wom<=3){meta.list.slice(0,3).forEach(n=>{const card=document.createElement('div');card.className='glass rounded-2xl p-4 text-center';card.innerHTML=`<img src="${n.photo||defaultLogo()}" class="h-40 w-40 object-cover rounded-2xl mx-auto ring-2 ring-white/10"/><div class="mt-2 font-semibold">${n.name}</div><div class="text-sm text-white/60">${n.klass||''}</div>`;pub.appendChild(card)});if(meta.list.length===0){pub.innerHTML='<div class="text-white/80">No nominees yet.</div>'}}else{pub.innerHTML='<div class="text-white/80">Week 4: Please pick a winner from Admin Controls.</div>'}}
$('#addNominee').onclick=async()=>{const n=$('#nomName').value.trim();if(!n)return showToast('Enter a name');const k=$('#nomClass').value.trim();const f=$('#nomPhoto').files[0];let photo=null;if(f){const r=new FileReader();r.onload=()=>{photo=r.result;const meta=currentNomBox();if(meta.list.length>=3)return showToast('Already have 3 nominees');meta.list.push({id:crypto.randomUUID(),name:n,klass:k,photo});save();$('#nomName').value='';$('#nomClass').value='';$('#nomPhoto').value='';renderBest()};r.readAsDataURL(f)}else{const meta=currentNomBox();if(meta.list.length>=3)return showToast('Already have 3 nominees');meta.list.push({id:crypto.randomUUID(),name:n,klass:k,photo});save();$('#nomName').value='';$('#nomClass').value='';renderBest()}}
$('#clearNominees').onclick=()=>{const meta=currentNomBox();meta.list=[];meta.winnerId=null;save();renderBest()}
$('#setWinner').onclick=()=>{const id=$('#winnerSelect').value;if(!id)return showToast('Choose a winner');const meta=currentNomBox();meta.winnerId=id;save();renderBest();showToast('Winner set')}
renderBest();

/* ---------- albums & gallery ---------- */
function ensureAlbum(){if(!db.currentAlbum){const first=Object.keys(db.albums)[0];db.currentAlbum=first||'General';db.albums[db.currentAlbum] ||= []}}
function renderAlbumPicker(){ensureAlbum();const sel=$('#albumSelect');sel.innerHTML='';Object.keys(db.albums).sort().forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;if(n===db.currentAlbum)o.selected=true;sel.appendChild(o)});if(Object.keys(db.albums).length===0){db.albums['General']=[];db.currentAlbum='General'};save()}
function renderGallery(){ensureAlbum();const g=$('#gallery');g.innerHTML='';(db.albums[db.currentAlbum]||[]).forEach((src,i)=>{const fig=document.createElement('figure');fig.className='relative';fig.innerHTML=`<img src="${src}" class="w-full h-32 object-cover rounded-xl ring-2 ring-white/10"/>${currentAdmin?'<button class="btn btn-ghost absolute top-1 right-1">✖</button>':''}`;if(currentAdmin)fig.querySelector('button').onclick=()=>{db.albums[db.currentAlbum].splice(i,1);save();renderGallery()};g.appendChild(fig)})}
$('#albumSelect').onchange=e=>{db.currentAlbum=e.target.value;save();renderGallery()}
$('#addAlbum').onclick=()=>{const n=$('#albumName').value.trim();if(!n)return showToast('Album name?');if(db.albums[n])return showToast('Album exists');db.albums[n]=[];db.currentAlbum=n;$('#albumName').value='';save();renderAlbumPicker();renderGallery()}
$('#renameAlbum').onclick=()=>{const n=$('#renameAlbumInput').value.trim();if(!n)return;const old=db.currentAlbum;if(!db.albums[old])return;db.albums[n]=db.albums[old];delete db.albums[old];db.currentAlbum=n;$('#renameAlbumInput').value='';save();renderAlbumPicker();renderGallery()}
$('#deleteAlbum').onclick=()=>{const a=db.currentAlbum;if(!a)return;delete db.albums[a];db.currentAlbum=null;ensureAlbum();save();renderAlbumPicker();renderGallery()}
$('#clearAlbum').onclick=()=>{db.albums[db.currentAlbum]=[];save();renderGallery()}
$('#galUpload').onchange=async e=>{const files=Array.from(e.target.files);if(files.length===0)return;for(const f of files){await new Promise(res=>{const r=new FileReader();r.onload=()=>{db.albums[db.currentAlbum].push(r.result);res()};r.readAsDataURL(f)})}save();renderGallery()}
renderAlbumPicker();renderGallery();

/* ---------- site settings ---------- */
$('#logoUploader').onchange=async e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{db.logoDataUrl=r.result;save();setLogo(r.result);showToast('Logo updated')};r.readAsDataURL(f)}
$('#exportData').onclick=()=>{const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='icstic-data.json';a.click()}
$('#importDataBtn').onclick=()=>$('#importFile').click()
$('#importFile').onchange=async e=>{const f=e.target.files[0];if(!f)return;const text=await f.text();try{const json=JSON.parse(text);Object.assign(db,json);save();location.reload()}catch{showToast('Invalid file')}}
$('#resetAll').onclick=()=>{if(confirm('Clear all data on this device?')){localStorage.removeItem('icstic');location.reload()}}

/* ---------- init ---------- */
window.addEventListener('load',()=>{if(window.lucide) lucide.createIcons();$('#memberWeek').textContent=weekKey(isoWeek())})
</script>
</body>
</html>
